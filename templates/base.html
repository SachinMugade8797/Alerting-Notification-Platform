<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        
        .alert { padding: 15px; margin: 10px 0; border-radius: 5px; position: relative; }
        .alert-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        .alert-warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .alert-critical { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        
        .btn { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        
        .popup-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; display: none;
        }
        .popup { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border-radius: 10px; z-index: 1001; max-width: 500px; width: 90%;
        }
        
        .read-status {
            position: absolute; top: 10px; right: 10px;
            display: flex; align-items: center; gap: 5px;
        }
        .read-tick { color: #28a745; font-size: 18px; }
        .unread-dot { width: 10px; height: 10px; background: #dc3545; border-radius: 50%; }
        .read-stats { 
            background: #f8f9fa; padding: 8px 12px; border-radius: 20px; 
            font-size: 12px; color: #6c757d; margin-left: 10px;
        }
        
        .switch {
            position: relative; display: inline-block; width: 60px; height: 34px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px;
            background-color: white; border-radius: 50%; transition: .4s;
        }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(26px); }
        
        .toast {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            padding: 15px 20px; border-radius: 5px; color: white;
            transform: translateX(400px); transition: transform 0.3s;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; 
        }
        
        nav { background-color: #343a40; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
        nav a { color: white; text-decoration: none; margin-right: 20px; padding: 5px 10px; border-radius: 3px; }
        nav a:hover { background-color: #495057; }
    </style>
</head>
<body>
    <nav>
        <a href="/">Home</a>
        <a href="/admin">Admin Dashboard</a>
        <a href="/dashboard/2">John's Dashboard</a>
        <a href="/dashboard/3">Jane's Dashboard</a>
    </nav>
    
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </div>

    <div id="alertPopup" class="popup-overlay">
        <div class="popup">
            <h3>ðŸ”” New Alerts!</h3>
            <div id="popupContent"></div>
            <button onclick="closePopup()" class="btn btn-primary">Got it!</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerHTML = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function markRead(alertId, userId) {
            const button = document.querySelector(`button[onclick="markRead(${alertId}, ${userId})"]`);
            if (button) {
                button.disabled = true;
                button.textContent = 'Reading...';
            }

            fetch('/api/mark-read', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({alert_id: alertId, user_id: userId})
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    showToast(data.message, 'success');
                    if (button) {
                        button.textContent = 'âœ… Read';
                        button.style.backgroundColor = '#6c757d';
                    }
                } else {
                    showToast(data.message, 'error');
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Mark as Read';
                    }
                }
            })
            .catch(() => {
                showToast('Network error', 'error');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Mark as Read';
                }
            });
        }

        function snoozeAlert(alertId, userId) {
            const button = document.querySelector(`button[onclick="snoozeAlert(${alertId}, ${userId})"]`);
            if (button) {
                button.disabled = true;
                button.textContent = 'Snoozing...';
            }

            fetch('/api/snooze-alert', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({alert_id: alertId, user_id: userId})
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    showToast(data.message, 'success');
                    const alertCard = document.querySelector(`[data-alert-id="${alertId}"]`);
                    if (alertCard) {
                        alertCard.style.opacity = '0.3';
                    }
                    if (button) {
                        button.textContent = 'ðŸ˜´ Snoozed';
                        button.style.backgroundColor = '#6c757d';
                    }
                } else {
                    showToast(data.message, 'error');
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Snooze for Today';
                    }
                }
            })
            .catch(() => {
                showToast('Network error', 'error');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Snooze for Today';
                }
            });
        }

        function toggleReminder(alertId) {
            fetch(`/api/toggle-reminder/${alertId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    showToast(data.message, 'success');
                }
            });
        }

        function deleteAlert(alertId) {
            if (confirm('Are you sure you want to delete this alert? This action cannot be undone.')) {
                fetch(`/api/delete-alert/${alertId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        showToast(data.message, 'success');
                        // Remove the alert from the page
                        const alertElement = document.querySelector(`[data-alert-id="${alertId}"]`);
                        if (alertElement) {
                            alertElement.remove();
                        }
                    } else {
                        showToast(data.message, 'error');
                    }
                })
                .catch(() => {
                    showToast('Network error while deleting alert', 'error');
                });
            }
        }

        function showNewAlertsPopup(newAlerts) {
            if (newAlerts && newAlerts.length > 0) {
                const popup = document.getElementById('alertPopup');
                const content = document.getElementById('popupContent');
                
                content.innerHTML = '';
                newAlerts.forEach(alert => {
                    content.innerHTML += `
                        <div class="alert alert-${alert.severity.toLowerCase()}">
                            <h4>${alert.title}</h4>
                            <p>${alert.message}</p>
                        </div>
                    `;
                });
                
                popup.style.display = 'block';
                setTimeout(() => closePopup(), 8000);
            }
        }

        function closePopup() {
            document.getElementById('alertPopup').style.display = 'none';
        }

        document.getElementById('alertPopup').addEventListener('click', function(e) {
            if (e.target === this) closePopup();
        });
    </script>
</body>
</html>

